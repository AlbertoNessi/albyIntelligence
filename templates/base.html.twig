<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}Alby Intelligence{% endblock %}</title>
        <link rel="icon" type="image/x-icon" href="{{ asset('images/favicon_AI.jpeg') }}">

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha256-PI8n5gCcz9cQqQXm3PEtDuPG8qx9oFsFctPg0S5zb8g=" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

        {% block stylesheets %}
        {% endblock %}

        {% block javascripts %}
        {% endblock %}
    </head>
    <body>
        {% block modals %}
            {% include('modals/success_modal.html.twig') %}
            {% include('modals/error_modal.html.twig') %}
        {% endblock %}

        {% block navbar %}
            {% include('navbar.html.twig') %}
        {% endblock %}

        {% block alert %}
            <div class="container" id="alertContainer"></div>
        {% endblock %}

        {% block body %}{% endblock %}

        <button id="analysePageButton" class="btn btn-primary position-fixed" style="bottom: 50px; right: 20px;">
            Analizza pagina
        </button>

        {% block footer %}
            {% include('footer.html.twig') %}
        {% endblock %}

        <script>
            {% block js %}
                function showAlert(message, type) {
                    let alertHtml = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
                    $("#alertContainer").html(alertHtml);

                    // Make the alert disappear after 3 seconds
                    setTimeout(function() {
                        $(".alert").alert('close');
                    }, 2000);
                }

                $('#analysePageButton').on('click', function() {
                    html2canvas(document.body).then(function(canvas) {
                        canvas.toBlob(function(blob) {
                            let sanitizedTitle = document.title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                            const formData = new FormData();
                            formData.append('image', blob, `${sanitizedTitle}.png`);
                            formData.append('prompt', "Describe the image");

                            $.ajax({
                                url: '{{ path('analyzeImage_url') }}',
                                type: 'POST',
                                data: formData,
                                processData: false,
                                contentType: false,
                                success: function(response) {
                                    displayAnalysisResult(response);
                                },
                                error: function(xhr, status, error) {
                                    showAlert('danger', 'Si Ã¨ veriricato un errore durante l\'analisi della pagina');
                                    console.log(xhr);
                                    console.log(status);
                                    console.log(error);
                                }
                            });
                        });
                    });
                });

                // Function to display the analysis result above the button
                function displayAnalysisResult(response) {
                    if (response['code'] === '200') {
                        showAlert('success', 'Immagine analizzata');

                        // Extract the content from the response
                        const content = response.response.choices[0].message.content;

                        // Check if the result container already exists and update it
                        if ($('#resultContainer').length) {
                            $('#resultContainer').text(content);
                        } else {
                            const resultContainer =
                                `<div class="card" id='resultContainer' style="position: fixed; bottom: 100px; right: 20px; width: 500px;">
                                  <div class="card-body">
                                    <p>${content}</p>
                                  </div>
                                </div>`;
                            $('#analysePageButton').before(resultContainer);
                        }
                    } else {
                        showAlert('danger', 'Immagine non analizzata');
                        console.warn('Response code was not 200:', response);
                    }
                }


            {% endblock %}
        </script>

        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
    </body>
</html>
